var pjax;cave.toolbar_setCallback(1,back);cave.toolbar_setCallback(2,function(){cave.toolbar_setActiveButton(2);pjax.loadUrl("/feed")});cave.toolbar_setCallback(3,function(){cave.toolbar_setActiveButton(3);pjax.loadUrl("/titles")});cave.toolbar_setCallback(4,function(){cave.toolbar_setActiveButton(4);checkForUpdates();pjax.loadUrl("/news/my_news")});cave.toolbar_setCallback(5,function(){cave.toolbar_setActiveButton(5);pjax.loadUrl("/users/menu")});cave.toolbar_setCallback(8,function(){});function initPostModules(){var els=document.querySelectorAll("[data-module-show]");console.log(els);if(!els)return;for(var i=0;i<els.length;i++){els[i].addEventListener("click",function(e){var el=e.currentTarget,show=el.getAttribute("data-module-show"),hide=el.getAttribute("data-module-hide"),header=el.getAttribute("data-header"),sound=el.getAttribute("data-sound"),message=el.getAttribute("data-message");if(!show||!hide)return;document.getElementById(hide).style.display="none";document.getElementById(show).style.display="block";if(header==="true")document.getElementById("header").style.display="block";else document.getElementById("header").style.display="none";console.log(message);if(message){cave.toolbar_setWideButtonMessage(message);cave.toolbar_setMode(1);cave.toolbar_setButtonType(1);cave.toolbar_setCallback(1,function(){document.getElementById("close-modal-button").click()})}else{cave.toolbar_setMode(0);cave.toolbar_setButtonType(0);cave.toolbar_setCallback(1,back)}initNewPost()})}}function back(){if(!pjax.canGoBack())cave.toolbar_setButtonType(0);else pjax.back()}function stopLoading(){cave.transition_end();cave.toolbar_setActiveButton(3);cave.snd_playBgm("BGM_CAVE_MAIN");cave.toolbar_setVisible(true)}function initAll(){pjax=Pjax.init({elements:"a[data-pjax]",selectors:["title","#body"]});pjax.initElements();console.log("Pjax initialized."+pjax);stopLoading()}var PostStorage={maxLocalStorageNum:3,getPosts:function(){return PostStorage.getAll()[0]},getAll:function(){for(var e={},t=cave.lls_getCount(),i=new RegExp("^[0-9]+$"),o=0,n=0;n<t;n++){var a=cave.lls_getKeyAt(n);i.test(a)&&(e[a]=cave.lls_getItem(a),o+=1)}return[e,o]},getCount:function(){return PostStorage.getAll()[1]},setItem:function(e){var t=(new Date).getTime();cave.lls_setItem(String(t),e)},removeItem:function(e){var t=JSON.parse(cave.lls_getItem(e));t&&t.screenShotKey&&cave.lls_removeItem(t.screenShotKey),cave.lls_removeItem(e)},hasKey:function(e){for(var t=cave.lls_getCount(),i=0;i<t;i++)if(e===cave.lls_getKeyAt(i))return!0;return!1},sweep:function(){var t=PostStorage.getAll(),i=t[0];if(t[1]>0)for(var o in i){var n=JSON.parse(cave.lls_getItem(o)).screenShotKey;n&&!PostStorage.hasKey(n)&&cave.lls_removeItem(o)}}};function EULA(){cave.lls_setItem("agree_olv","1")}function testOffline(){var posts=PostStorage.getAll();var text=JSON.stringify(posts,null,"\t");POST("/test",text,function(){window.alert("sent")})}function POST(url,data,callback){var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(this.readyState===4){return callback(this)}};xhttp.open("POST",url,true);xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhttp.send(data)}function GET(url,callback){var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(this.readyState===4){return callback(this)}};xhttp.open("GET",url,true);xhttp.send()}document.addEventListener("DOMContentLoaded",initAll);document.addEventListener("PjaxRequest",function(e){console.log(e);cave.transition_begin()});document.addEventListener("PjaxLoaded",function(e){console.log(e)});document.addEventListener("PjaxDone",function(e){window.alert(pjax.history);if(pjax.canGoBack())cave.toolbar_setButtonType(1);else cave.toolbar_setButtonType(0);cave.transition_end()});